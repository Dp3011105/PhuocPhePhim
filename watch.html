<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHIM N+ | Xem Phim</title>
    <link rel="icon" type="image/png" href="img/image2-fotor-20250813113121.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#0a0a0a',
                            800: '#121212',
                            700: '#1a1a1a',
                            600: '#222222',
                            500: '#2a2a2a',
                        },
                        netflix: {
                            red: '#e50914',
                        }
                    },
                },
            },
        };
    </script>
    <style>
        body {
            background-color: #0a0a0a;
            color: #e5e5e5;
            margin: 0;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            transition: background-color 0.5s ease;
        }
        
        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            background-color: #000;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
            transition: box-shadow 0.5s ease;
        }
        
        .video-container.ambient {
            box-shadow: none;
        }
        
        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            z-index: 1;
        }
        
        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 10px;
            pointer-events: none;
            transition: opacity 0.3s ease;
            opacity: 0;
        }
        
        .video-overlay.active {
            opacity: 1;
        }
        
        .video-overlay > * {
            pointer-events: auto;
        }
        
        .control-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }
        
        .ambient-btn, .skip-intro-btn, .next-episode-btn, .subtitle-toggle, .thuyet-minh-btn, .long-tieng-btn {
            background-color: rgba(229, 9, 20, 0.9);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 0.25rem;
            font-weight: bold;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            border: 1px solid #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .ambient-btn:hover, .skip-intro-btn:hover, .next-episode-btn:hover, .subtitle-toggle:hover, .thuyet-minh-btn:hover, .long-tieng-btn:hover {
            background-color: #e50914;
            transform: scale(1.05);
            border-color: #e50914;
        }
        
        .subtitle-toggle.active {
            background-color: #e50914;
            color: white;
            border-color: #e50914;
        }
        
        .episode-list {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .episode-btn {
            background-color: #2a2a2a;
            color: #e5e5e5;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }
        
        .episode-btn:hover {
            background-color: #333;
            transform: scale(1.05);
        }
        
        .episode-btn.active {
            background-color: #e50914;
            color: white;
        }
        
        .video-card {
            transition: all 0.3s ease-in-out;
            background-color: #1a1a1a;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
            animation-delay: calc(var(--index) * 0.1s);
        }
        
        .video-card:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.6);
            background-color: #222222;
            z-index: 10;
        }
        
        .video-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .video-card:hover img {
            transform: scale(1.1);
        }

        .filter-container {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: transparent;
            transition: background-color 0.3s ease;
            padding: 0.5rem 0;
        }
        
        .filter-container.scrolled {
            background-color: #0a0a0a;
        }
        
        .filter-btn {
            transition: all 0.2s ease;
            background-color: transparent;
            color: #e5e5e5;
            border: 1px solid transparent;
            border-radius: 0.25rem;
            padding: 0.5rem 1rem;
        }
        
        .filter-container.scrolled .filter-btn {
            background-color: #2a2a2a;
            border: 1px solid #333;
        }
        
        .filter-btn:hover {
            background-color: #333;
            transform: translateY(-2px);
        }
        
        .filter-container.scrolled .filter-btn:hover {
            background-color: #444;
        }
        
        .filter-btn.active {
            background-color: #e50914;
            color: white;
            border-color: #e50914;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(229, 9, 20, 0.3);
        }

        .search-input {
            background-color: transparent;
            color: #e5e5e5;
            border: 1px solid #333;
            border-radius: 0.25rem;
            padding: 0.5rem 1rem;
            width: 100%;
            max-width: 300px;
            transition: all 0.2s ease;
        }

        .filter-container.scrolled .search-input {
            background-color: #2a2a2a;
        }

        .search-input:focus {
            outline: none;
            border-color: #e50914;
            box-shadow: 0 0 5px rgba(229, 9, 20, 0.5);
        }

        /* Chat box styles */
        .chat-container {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 350px;
            height: 70vh;
            background-color: rgba(18, 18, 18, 0.95);
            border-left: 1px solid #333;
            border-radius: 0.5rem 0 0 0.5rem;
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            z-index: 1000;
            opacity: 1;
        }

        .chat-container.hidden {
            transform: translateY(-50%) translateX(100%);
            opacity: 0;
        }

        .chat-header {
            padding: 0.75rem;
            background-color: #1a1a1a;
            border-bottom: 1px solid #333;
            border-radius: 0.5rem 0 0 0;
        }

        .chat-header h3 {
            font-size: 1rem;
            font-weight: bold;
            color: #fff;
            margin: 0;
            text-align: center;
        }

        .chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            scrollbar-width: thin;
            scrollbar-color: #444 #1a1a1a;
        }

        .chat-box::-webkit-scrollbar {
            width: 6px;
        }

        .chat-box::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .chat-box::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }

        .message {
            display: flex;
            flex-direction: column;
            padding: 0.5rem 0.75rem;
            background-color: #2a2a2a;
            border-radius: 0.5rem;
            max-width: 80%;
            word-wrap: break-word;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        .message.self {
            align-self: flex-end;
            background-color: #e50914;
            color: white;
        }

        .username {
            font-weight: bold;
            font-size: 0.85rem;
            color: #e5e5e5;
            margin-bottom: 0.2rem;
        }

        .message.self .username {
            color: #fff;
        }

        .message-text {
            font-size: 0.9rem;
            color: #e5e5e5;
        }

        .message.self .message-text {
            color: #fff;
        }

        .chat-input-container {
            padding: 0.75rem;
            background-color: #1a1a1a;
            border-top: 1px solid #333;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .chat-username, .chat-input {
            background-color: #2a2a2a;
            color: #e5e5e5;
            border: 1px solid #333;
            border-radius: 0.25rem;
            padding: 0.5rem;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .chat-username {
            width: 80px;
        }

        .chat-input {
            flex: 1;
        }

        .chat-username:focus, .chat-input:focus {
            border-color: #e50914;
            box-shadow: 0 0 5px rgba(229, 9, 20, 0.5);
        }

        .chat-send-btn, .chat-toggle-btn {
            background-color: #e50914;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .chat-send-btn:hover, .chat-toggle-btn:hover {
            background-color: #c10812;
            transform: scale(1.05);
        }

        .chat-toggle-btn.active {
            background-color: #2a2a2a;
            color: #e5e5e5;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 640px) {
            .video-container {
                padding-bottom: 75%;
            }

            .video-card img {
                width: 100%;
                height: 120px;
            }
            
            .video-card h3 {
                font-size: 0.875rem;
                margin-bottom: 0.25rem;
            }
            
            .video-card p {
                font-size: 0.7rem;
                margin: 0.1rem 0;
            }

            .ambient-btn, .skip-intro-btn, .next-episode-btn, .subtitle-toggle, .thuyet-minh-btn, .long-tieng-btn {
                padding: 0.3rem 0.6rem;
                font-size: 0.7rem;
            }

            .filter-btn, .chat-toggle-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.75rem;
                margin-bottom: 0.25rem;
            }

            .search-input {
                max-width: 100%;
            }

            .filter-container {
                gap: 0.5rem;
                justify-content: center;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            
            .filter-container::-webkit-scrollbar {
                display: none;
            }

            .chat-container {
                width: 100%;
                height: 50vh;
                top: auto;
                bottom: 0;
                transform: translateY(0);
                border-radius: 0.5rem 0.5rem 0 0;
                border-left: none;
                border-top: 1px solid #333;
            }

            .chat-container.hidden {
                transform: translateY(100%);
                opacity: 0;
            }
        }

        @media (min-width: 641px) and (max-width: 1024px) {
            .video-card img {
                height: 150px;
            }

            .chat-container {
                width: 300px;
            }
        }
    </style>
</head>
<body class="font-sans bg-dark-900 text-gray-200">
    <div class="container mx-auto px-4 py-4">
        <header class="mb-4">
            <a href="index.html" class="text-3xl font-bold text-white">PHIM N+</a>
        </header>

        <div class="filter-container flex flex-wrap gap-2 justify-center sm:justify-start">
            <!-- <input id="search-input" class="search-input" placeholder="Tìm kiếm phim theo tiêu đề...">  Thay thế -->
            <a id="search-input" >
            <button class="filter-btn px-4 py-2 rounded-lg" data-filter="all">Trang chủ</button>
          
            <a href="https://discord.gg/uqNA78fs9G" target="_blank" class="filter-btn px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 text-white">Discord</a>
            <button id="chat-toggle-btn" class="chat-toggle-btn"> Ẩn Chat</button>
        </div>

        <div id="main-video-section" class="w-full mt-6">
            <div class="video-container">
                <div id="video-player"></div>
                <div class="video-overlay">
                    <div class="control-buttons">
                        <button id="skip-intro-btn" class="skip-intro-btn hidden">Bỏ qua phần giới thiệu</button>
                        <button id="next-episode-btn" class="next-episode-btn hidden">Tập tiếp theo <span id="countdown"></span></button>
                    </div>
                </div>
            </div>
            <div class="control-buttons mt-2">
                <button id="ambient-btn" class="ambient-btn">Chế độ điện ảnh</button>
                <button id="subtitle-toggle" class="subtitle-toggle hidden">Tắt phụ đề</button>
                <button id="thuyet-minh-btn" class="thuyet-minh-btn hidden">Phát Thuyết Minh</button>
                <button id="long-tieng-btn" class="thuyet-minh-btn hidden">Phát Lồng Tiếng</button>
            </div>
            <h2 id="main-video-title" class="text-xl font-semibold text-white mt-4"></h2>
            <div id="episode-list" class="episode-list hidden"></div>
        </div>

        <div id="recommended-videos" class="mt-4">
            <h2 class="text-xl font-bold text-white mb-4">Phim gợi ý</h2>
            <div id="recommended-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4"></div>
        </div>

        <!-- Chat Container -->
        <div id="chat-container" class="chat-container">
            <div class="chat-header">
                <button id="chat-toggle-btnn" class="chat-toggle-btn"> Ẩn X</button>
                <h5>Mở lại đoạn chat ở trên cùng trang web bên nút Discord nha , Mình đang phát triển nên còn lỗi nhiều lắm </h5>
                <h3>Chat cộng đồng</h3>
            </div>
            <div id="chat-box" class="chat-box"></div>
            <div class="chat-input-container">
                <input type="text" id="chat-username" class="chat-username" placeholder="Tên..." value="Anonymous">
                <input type="text" id="chat-input" class="chat-input" placeholder="Nhập tin nhắn...">
                <button id="chat-send-btn" class="chat-send-btn">Gửi</button>
            </div>
        </div>
    </div>

    <script>
        // Filter scroll effect
        const filterContainer = document.querySelector('.filter-container');
        window.addEventListener('scroll', () => {
            if (window.scrollY > 50) {
                filterContainer.classList.add('scrolled');
            } else {
                filterContainer.classList.remove('scrolled');
            }
        });

        let videos = [];
        let currentVideoData = null;
        let hls = null;
        let colorUpdateInterval = null;

        // Cookie handling functions
        function setCookie(name, value, seconds) {
            const date = new Date();
            date.setTime(date.getTime() + (seconds * 1000));
            const expires = "expires=" + date.toUTCString();
            document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/;SameSite=Strict";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.indexOf(nameEQ) === 0) {
                    return decodeURIComponent(cookie.substring(nameEQ.length, cookie.length));
                }
            }
            return null;
        }

        // Chat functionality
        const ABLY_KEY = "BDzatA.Frs1jw:_RWjZtJGW0rzDHS6UdJuhfrJbEka-ZdAeYNzp7T2Zlc";
        const ably = new Ably.Realtime({ key: ABLY_KEY, clientId: `client-${Math.random().toString(36).substr(2, 9)}` });
        const channel = ably.channels.get("ephemeral-chat");
        const chatContainer = document.getElementById("chat-container");
        const chatToggleBtn = document.getElementById("chat-toggle-btn");
        const chatToggleBtnn = document.getElementById("chat-toggle-btnn");
        const chatBox = document.getElementById("chat-box");

        // Load chat history from cookie
        function loadChatHistory() {
            const chatHistory = getCookie("chatHistory");
            if (chatHistory) {
                try {
                    const messages = JSON.parse(chatHistory);
                    messages.forEach(msg => {
                        const el = document.createElement("div");
                        el.className = `message ${msg.clientId === ably.clientId ? 'self' : ''}`;
                        el.innerHTML = `
                            <span class="username">${msg.username}</span>
                            <span class="message-text">${msg.text}</span>
                        `;
                        chatBox.appendChild(el);
                    });
                    if (isChatVisible) {
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                } catch (e) {
                    console.error("Lỗi khi khôi phục lịch sử chat từ cookie:", e);
                }
            }
        }

        // Save chat message to cookie
        function saveChatMessage(clientId, username, text) {
            let chatHistory = getCookie("chatHistory");
            let messages = [];
            if (chatHistory) {
                try {
                    messages = JSON.parse(chatHistory);
                    if (!Array.isArray(messages)) {
                        messages = [];
                    }
                } catch (e) {
                    console.error("Lỗi khi phân tích lịch sử chat từ cookie:", e);
                    messages = [];
                }
            }
            messages.push({ clientId, username, text });
            // Limit to last 100 messages to avoid cookie size issues
            if (messages.length > 100) {
                messages = messages.slice(-100);
            }
            setCookie("chatHistory", JSON.stringify(messages), 10800); // 3 hours
        }

        // Toggle chat visibility
        let isChatVisible = true;
        chatToggleBtn.addEventListener('click', () => {
            isChatVisible = !isChatVisible;
            chatContainer.classList.toggle('hidden', !isChatVisible);
            chatToggleBtn.classList.toggle('active', !isChatVisible);
            chatToggleBtn.textContent = isChatVisible ? 'Ẩn Chat' : 'Mở Chat';
            if (isChatVisible) {
                chatBox.scrollTop = chatBox.scrollHeight;
            }


        });
        chatToggleBtnn.addEventListener('click', () => {
            isChatVisible = !isChatVisible;
            chatContainer.classList.toggle('hidden', !isChatVisible);
            chatToggleBtn.classList.toggle('active', !isChatVisible);
            chatToggleBtn.textContent = isChatVisible ? 'Ẩn Chat' : 'mở Chat';
            if (isChatVisible) {
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            
        });


       

        // Receive messages
        channel.subscribe("message", (msg) => {
            const el = document.createElement("div");
            const username = document.getElementById("chat-username").value.trim() || "Anonymous";
            el.className = `message ${msg.clientId === ably.clientId ? 'self' : ''}`;
            el.innerHTML = `
                <span class="username">${msg.data.username}</span>
                <span class="message-text">${msg.data.text}</span>
            `;
            chatBox.appendChild(el);
            saveChatMessage(msg.clientId, msg.data.username, msg.data.text);
            if (isChatVisible) {
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        });

        // Send message
        document.getElementById("chat-send-btn").onclick = () => {
            const text = document.getElementById("chat-input").value.trim();
            const username = document.getElementById("chat-username").value.trim() || "Anonymous";
            if (text) {
                channel.publish("message", { username, text });
                document.getElementById("chat-input").value = "";
            }
        };

        // Send message with Enter key
        document.getElementById("chat-input").addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                document.getElementById("chat-send-btn").click();
            }
        });

        // Load chat history on page load
        document.addEventListener("DOMContentLoaded", () => {
            loadChatHistory();
        });

        function parseTimeToSeconds(timeStr) {
            if (!timeStr || typeof timeStr !== 'string') return 0;
            const [minutes, seconds] = timeStr.split(':').map(Number);
            return (minutes || 0) * 60 + (seconds || 0);
        }

        function cleanVideoUrl(url) {
            if (!url) return '';
            try {
                const urlObj = new URL(url);
                const trackingParams = [
                    'utm_source', 'utm_medium', 'utm_campaign',
                    'utm_term', 'utm_content', 'fbclid',
                    'gclid', 'yclid', 'msclkid'
                ];
                trackingParams.forEach(param => urlObj.searchParams.delete(param));
                return urlObj.toString();
            } catch (e) {
                console.error('Lỗi làm sạch URL video:', e);
                return url;
            }
        }

        function isAdUrl(url) {
            if (!url) return false;
            const adKeywords = [
                'ads', 'advert', 'promo', 'sponsor', 'banner', 'popup', 'click', 'offer',
                'doubleclick', 'adservice', 'affiliate', 'tracking', 'marketing', 'adnetwork',
                'campaign', 'analytics', 'pixel', 'redirect', 'clk', 'adclick', 'adserver'
            ];
            const adDomains = [
                'adsense.google.com', 'doubleclick.net', 'googleadservices.com',
                'googlesyndication.com', 'advertising.com', 'adfox.ru', 'adform.net',
                'adriver.ru', 'adroll.com', 'taboola.com', 'outbrain.com', 'criteo.com',
                'pubmatic.com', 'rubiconproject.com', 'openx.com'
            ];
            try {
                const urlObj = new URL(url.toLowerCase());
                const hostname = urlObj.hostname;
                const path = urlObj.pathname;
                const query = urlObj.search;
                if (adDomains.some(domain => hostname.includes(domain))) return true;
                if (adKeywords.some(keyword => hostname.includes(keyword) || path.includes(keyword) || query.includes(keyword))) return true;
                const adPatterns = [
                    /\/(ad|ads|advert|banner|pop|clk|redirect)\//i,
                    /\.(ads|ad|banner|pop)\./i,
                    /[?&](utm_|ad_|clk_|aff_)/i
                ];
                if (adPatterns.some(pattern => pattern.test(url))) return true;
                return false;
            } catch (e) {
                console.error('Lỗi kiểm tra URL quảng cáo:', e);
                return false;
            }
        }

        function getRandomVideos(videos, count, excludeVideoId) {
            const filtered = videos.filter(v => v.tap[0]?.video !== excludeVideoId);
            const shuffled = [...filtered].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, Math.min(count, filtered.length));
        }

        function getVideoTitle(video) {
            return video.TieuDe && video.TieuDe.trim() !== '' ? video.TieuDe : extractTitleFromUrl(video.tap[0]?.video);
        }

        function extractTitleFromUrl(url) {
            if (!url) return "Video không có tiêu đề";
            try {
                const match = url.match(/\/video\.[^/]+\/(.+)$/);
                if (match && match[1] && match[1] !== '_') {
                    return match[1]
                        .replace(/_/g, ' ')
                        .replace(/\b\w/g, c => c.toUpperCase())
                        .replace(/%20/g, ' ');
                }
            } catch (e) {
                console.error('Lỗi phân tích tiêu đề video:', e);
            }
            return "Video không có tiêu đề";
        }

        function displayRecommendedVideos(excludeVideoId) {
            const recommendedList = document.getElementById("recommended-list");
            recommendedList.innerHTML = "";

            const recommendedVideos = getRandomVideos(videos, 10, excludeVideoId);

            recommendedVideos.forEach((vid, index) => {
                const videoCard = document.createElement("div");
                videoCard.className = "video-card";
                videoCard.style.setProperty('--index', index);

                const title = getVideoTitle(vid);
                const thumbnail = vid.anh || 'img/placeholder.jpg';
                const categories = vid.boloc ? vid.boloc.join(", ") : '';
                const videoId = vid.tap[0]?.video || '';

                videoCard.innerHTML = `
                    <div class="overflow-hidden">
                        <img src="${thumbnail}" alt="${title}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-3">
                        <h3 class="text-sm font-medium text-white line-clamp-2">${title}</h3>
                        <p class="text-xs text-gray-400 mt-1">${categories}</p>
                    </div>
                `;

                videoCard.addEventListener("click", () => {
                    window.location.href = `watch.html?id=${encodeURIComponent(videoId)}&title=${encodeURIComponent(title)}`;
                });

                recommendedList.appendChild(videoCard);
            });
        }

        function playVideo(videoData, title, seriesId, episodeIndex = 0) {
            const episodeData = videoData.tap && videoData.tap[episodeIndex] ? videoData.tap[episodeIndex] : videoData.tap[0];
            const cleanUrl = cleanVideoUrl(episodeData.video);
            const videoId = cleanUrl;
            const videoContainer = document.getElementById("video-player");
            videoContainer.innerHTML = '';

            if (isAdUrl(cleanUrl)) {
                console.log("Đã chặn URL quảng cáo:", cleanUrl);
                return;
            }

            try {
                new URL(cleanUrl);
            } catch (e) {
                console.error('URL video không hợp lệ:', cleanUrl);
                return;
            }

            currentVideoData = {
                videoId,
                introStart: episodeData.GioiThieuBatDau,
                introEnd: episodeData.GioiThieuKetThuc,
                url: cleanUrl,
                episodes: videoData.tap,
                episodeIndex,
                format: videoData.Dang,
                seriesId,
                subtitle: episodeData.subtitle || null,
                audioType: episodeData.audioType || 'dubbed'
            };

            const video = document.createElement('video');
            video.id = 'main-video';
            video.controls = true;
            video.autoplay = true;
            video.setAttribute('crossorigin', 'anonymous');
            video.style.width = '100%';
            video.style.height = '100%';
            video.setAttribute('playsinline', '');
            videoContainer.appendChild(video);

            if (currentVideoData.subtitle) {
                const track = document.createElement('track');
                track.id = 'vtt-track';
                track.kind = 'subtitles';
                track.src = currentVideoData.subtitle;
                track.srclang = 'vi';
                track.label = 'Tiếng Việt';
                track.default = true;
                video.appendChild(track);

                track.addEventListener('error', () => {
                    console.error('Lỗi tải file phụ đề:', currentVideoData.subtitle);
                });

                video.addEventListener('loadedmetadata', () => {
                    setTimeout(() => {
                        if (video.textTracks[0]) {
                            video.textTracks[0].mode = 'showing';
                        }
                        const subtitleToggle = document.getElementById('subtitle-toggle');
                        subtitleToggle.classList.remove('hidden');
                        subtitleToggle.classList.add('active');
                        subtitleToggle.textContent = 'Tắt phụ đề';
                    }, 200);
                });
            }

            const thuyetMinhBtn = document.getElementById('thuyet-minh-btn');
            const longTiengBtn = document.getElementById('long-tieng-btn');
            thuyetMinhBtn.classList.add('hidden');
            longTiengBtn.classList.add('hidden');

            if (videoData.ThuyetMinh && videoData.ThuyetMinh.length > 0) {
                thuyetMinhBtn.classList.remove('hidden');
                thuyetMinhBtn.onclick = () => {
                    const thuyetMinhVideo = videos.find(v => v.id === videoData.ThuyetMinh[0]);
                    if (thuyetMinhVideo) {
                        const thuyetMinhVideoId = cleanVideoUrl(thuyetMinhVideo.tap[0]?.video);
                        const thuyetMinhTitle = getVideoTitle(thuyetMinhVideo);
                        window.location.href = `watch.html?id=${encodeURIComponent(thuyetMinhVideoId)}&title=${encodeURIComponent(thuyetMinhTitle)}`;
                    }
                };
            }

            if (videoData.LongTieng && videoData.LongTieng.length > 0) {
                longTiengBtn.classList.remove('hidden');
                longTiengBtn.onclick = () => {
                    const longTiengVideo = videos.find(v => v.id === videoData.LongTieng[0]);
                    if (longTiengVideo) {
                        const longTiengVideoId = cleanVideoUrl(longTiengVideo.tap[0]?.video);
                        const longTiengTitle = getVideoTitle(longTiengVideo);
                        window.location.href = `watch.html?id=${encodeURIComponent(longTiengVideoId)}&title=${encodeURIComponent(longTiengTitle)}`;
                    }
                };
            }

            if (Hls.isSupported() && currentVideoData.format === '.m3u8') {
                if (hls) hls.destroy();
                hls = new Hls();
                hls.loadSource(cleanUrl);
                hls.attachMedia(video);
                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.error('HLS Error:', data);
                });
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    video.play().catch(e => console.error('Lỗi phát video:', e));
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl') && currentVideoData.format === '.m3u8') {
                video.src = cleanUrl;
                video.addEventListener('loadedmetadata', () => {
                    video.play().catch(e => console.error('Lỗi phát video:', e));
                });
            } else {
                console.error('Trình duyệt không hỗ trợ HLS hoặc định dạng video không phù hợp');
                return;
            }

            document.getElementById("main-video-title").textContent = title;
            const episodeList = document.getElementById("episode-list");
            episodeList.classList.toggle('hidden', !videoData.tap || videoData.tap.length <= 1);
            episodeList.innerHTML = '';
            if (videoData.tap && videoData.tap.length > 1) {
                videoData.tap.forEach((ep, idx) => {
                    const btn = document.createElement('button');
                    btn.className = `episode-btn ${idx === episodeIndex ? 'active' : ''}`;
                    btn.textContent = ep.tapSo ? `Tập ${ep.tapSo}` : `Phần ${idx + 1}`;
                    btn.addEventListener('click', () => {
                        playVideo(videoData, title, seriesId, idx);
                    });
                    episodeList.appendChild(btn);
                });
            }

            displayRecommendedVideos(seriesId);
            setupVideoControls(video, videoData, title, seriesId);
        }

        function getAverageColor(video) {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth / 10;
            canvas.height = video.videoHeight / 10;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            let r = 0, g = 0, b = 0;
            const totalPixels = imageData.length / 4;
            for (let i = 0; i < imageData.length; i += 4) {
                r += imageData[i];
                g += imageData[i + 1];
                b += imageData[i + 2];
            }
            r = Math.floor(r / totalPixels);
            g = Math.floor(g / totalPixels);
            b = Math.floor(b / totalPixels);
            return { r, g, b };
        }

        function setupVideoControls(videoElement, videoData, title, seriesId) {
            const videoOverlay = document.querySelector('.video-overlay');
            const skipBtn = document.getElementById('skip-intro-btn');
            const nextEpisodeBtn = document.getElementById('next-episode-btn');
            const ambientBtn = document.getElementById('ambient-btn');
            const subtitleToggle = document.getElementById('subtitle-toggle');
            const videoContainer = document.querySelector('.video-container');
            let isAmbient = false;
            let countdownInterval;

            function isInIntro() {
                if (currentVideoData && currentVideoData.introStart && currentVideoData.introEnd) {
                    const currentTime = videoElement.currentTime;
                    const introStartSec = parseTimeToSeconds(currentVideoData.introStart);
                    const introEndSec = parseTimeToSeconds(currentVideoData.introEnd);
                    return currentTime >= introStartSec && currentTime <= introEndSec;
                }
                return false;
            }

            function showControls() {
                videoOverlay.classList.add('active');
            }

            function hideControls() {
                if (!isInIntro() && !isNearEnd()) {
                    videoOverlay.classList.remove('active');
                }
            }

            function isNearEnd() {
                if (currentVideoData && videoElement.duration) {
                    const remainingTime = videoElement.duration - videoElement.currentTime;
                    return remainingTime <= 8 && currentVideoData.episodes && currentVideoData.episodeIndex < currentVideoData.episodes.length - 1;
                }
                return false;
            }

            videoOverlay.addEventListener('mousemove', showControls);
            videoOverlay.addEventListener('touchstart', (e) => {
                e.preventDefault();
                showControls();
            });
            videoOverlay.addEventListener('mouseleave', hideControls);

            videoElement.addEventListener('timeupdate', () => {
                if (currentVideoData) {
                    const currentTime = videoElement.currentTime;
                    if (currentVideoData.introStart && currentVideoData.introEnd) {
                        const introStartSec = parseTimeToSeconds(currentVideoData.introStart);
                        const introEndSec = parseTimeToSeconds(currentVideoData.introEnd);
                        skipBtn.classList.toggle('hidden', currentTime > introEndSec || currentTime < introStartSec);
                        if (currentTime >= introStartSec && currentTime <= introEndSec) {
                            videoOverlay.classList.add('active');
                        }
                    } else {
                        skipBtn.classList.add('hidden');
                    }

                    if (isNearEnd()) {
                        nextEpisodeBtn.classList.remove('hidden');
                        videoOverlay.classList.add('active');
                        const remainingTime = Math.ceil(videoElement.duration - videoElement.currentTime);
                        document.getElementById('countdown').textContent = `(${remainingTime}s)`;
                        if (!countdownInterval) {
                            countdownInterval = setInterval(() => {
                                const remaining = Math.ceil(videoElement.duration - videoElement.currentTime);
                                if (remaining <= 0) {
                                    clearInterval(countdownInterval);
                                    countdownInterval = null;
                                    if (currentVideoData.episodeIndex < currentVideoData.episodes.length - 1) {
                                        playVideo(videoData, title, seriesId, currentVideoData.episodeIndex + 1);
                                    }
                                } else {
                                    document.getElementById('countdown').textContent = `(${remaining}s)`;
                                }
                            }, 1000);
                        }
                    } else {
                        nextEpisodeBtn.classList.add('hidden');
                        if (countdownInterval) {
                            clearInterval(countdownInterval);
                            countdownInterval = null;
                        }
                    }
                }
            });

            skipBtn.addEventListener('click', () => {
                if (currentVideoData && currentVideoData.introEnd) {
                    const introEndSec = parseTimeToSeconds(currentVideoData.introEnd);
                    videoElement.currentTime = introEndSec;
                    skipBtn.classList.add('hidden');
                }
            });

            nextEpisodeBtn.addEventListener('click', () => {
                if (currentVideoData && currentVideoData.episodeIndex < currentVideoData.episodes.length - 1) {
                    playVideo(videoData, title, seriesId, currentVideoData.episodeIndex + 1);
                }
            });

            ambientBtn.addEventListener('click', () => {
                if (currentVideoData.format !== '.m3u8') {
                    console.log('Chế độ điện ảnh chỉ hỗ trợ file .m3u8');
                    return;
                }
                isAmbient = !isAmbient;
                if (isAmbient) {
                    videoContainer.classList.add('ambient');
                    ambientBtn.textContent = 'Thoát chế độ điện ảnh';
                    colorUpdateInterval = setInterval(() => {
                        if (videoElement.videoWidth > 0 && videoElement.videoHeight > 0) {
                            const color = getAverageColor(videoElement);
                            const rgb = `rgb(${color.r}, ${color.g}, ${color.b})`;
                            const rgba30 = `rgba(${color.r}, ${color.g}, ${color.b}, 0.5)`;
                            const rgba60 = `rgba(${color.r}, ${color.g}, ${color.b}, 0.3)`;
                            videoContainer.style.boxShadow = `0 0 30px ${rgba30}, 0 0 60px ${rgba60}`;
                            document.body.style.backgroundColor = rgb;
                        }
                    }, 2000);
                } else {
                    videoContainer.classList.remove('ambient');
                    ambientBtn.textContent = 'Chế độ điện ảnh';
                    clearInterval(colorUpdateInterval);
                    colorUpdateInterval = null;
                    videoContainer.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.5)';
                    document.body.style.backgroundColor = '#0a0a0a';
                }
            });

            subtitleToggle.addEventListener('click', () => {
                const track = videoElement.textTracks[0];
                if (track) {
                    if (track.mode === 'showing') {
                        track.mode = 'hidden';
                        subtitleToggle.textContent = 'Bật phụ đề';
                        subtitleToggle.classList.remove('active');
                    } else {
                        track.mode = 'showing';
                        subtitleToggle.textContent = 'Tắt phụ đề';
                        subtitleToggle.classList.add('active');
                    }
                }
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll(".filter-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    window.location.href = `index.html?filter=${encodeURIComponent(btn.dataset.filter)}`;
                });
            });

            document.getElementById("search-input").addEventListener("input", (e) => {
                window.location.href = `index.html?search=${encodeURIComponent(e.target.value)}`;
            });

            const urlParams = new URLSearchParams(window.location.search);
            const videoId = urlParams.get('id');
            const title = urlParams.get('title');

            if (!videoId || !title) {
                return;
            }

            fetch("phim.json")
                .then(response => response.json())
                .then(data => {
                    videos = data.filter(v => v.tap && v.tap[0]?.video && v.Dang === '.m3u8');
                    const videoData = videos.find(v => v.tap.some(ep => cleanVideoUrl(ep.video) === cleanVideoUrl(videoId)));
                    if (videoData) {
                        const episodeIndex = videoData.tap.findIndex(ep => cleanVideoUrl(ep.video) === cleanVideoUrl(videoId));
                        playVideo(videoData, decodeURIComponent(title), videoId, episodeIndex);
                    }
                })
                .catch(error => {
                    console.error("Lỗi tải danh sách video:", error);
                });
        });
    </script>
</body>
</html>